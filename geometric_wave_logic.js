<full logic code pasted here>